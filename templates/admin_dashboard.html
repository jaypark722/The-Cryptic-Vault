{% extends "base.html" %}
{% block title %}ADMIN | Honeypot Monitor{% endblock %}

{% block content %}

<div class="p-6 bg-market-gray border border-red-500 rounded-lg shadow-xl mb-8">
<p class="text-2xl text-red-500 font-bold mb-3 border-b border-market-border pb-2"> HONEYPOT MONITORING DASHBOARD </p>
<a href="{{ url_for('export_logs') }}" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded transition duration-150 shadow-lg inline-block">
üì• EXPORT ALL LOGS (JSON)
</a>
</div>

<!-- Flash Messages -->

{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
{% for category, message in messages %}
<div class="mb-4 p-4 rounded-lg {% if category == 'success' %}bg-green-900 border border-green-500 text-green-100{% elif category == 'warning' %}bg-yellow-900 border border-yellow-500 text-yellow-100{% else %}bg-red-900 border border-red-500 text-red-100{% endif %}">
{{ message }}
</div>
{% endfor %}
{% endif %}
{% endwith %}

<!-- Pending Deposits Section -->

{% if pending_deposits %}

<div class="bg-yellow-900 border border-yellow-500 p-6 rounded-lg shadow-xl mb-8">
<h2 class="text-yellow-300 font-bold text-xl mb-4 border-b border-yellow-600 pb-2">‚ö†Ô∏è PENDING DEPOSITS ({{ pending_deposits|length }})</h2>
<div class="space-y-4">
{% for deposit in pending_deposits %}
<div class="bg-market-gray border border-yellow-400 p-4 rounded-lg flex items-center justify-between">
<div class="flex-1">
<p class="text-white font-semibold">User: <span class="text-yellow-300">{{ deposit.username }}</span> (ID: {{ deposit.user_id }})</p>
<p class="text-gray-400 text-sm">Current Balance: {{ deposit.current_balance }}</p>
<p class="text-gray-400 text-sm">Pending Since: {{ deposit.pending_since }}</p>
<p class="text-gray-400 text-sm">Claimed Amount: <span class="text-yellow-300 font-mono">{{ deposit.claimed_amount_display }}</span></p>
</div>
<div class="flex gap-2">
<form method="POST" action="{{ url_for('admin_confirm_deposit', user_id=deposit.user_id) }}" class="inline">
<!-- Pass the raw float amount, not the formatted string -->
<input type="hidden" name="amount" value="{{ deposit.claimed_amount_raw }}">
<button type="submit" class="bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-4 rounded transition">
‚úì CONFIRM
</button>
</form>
<form method="POST" action="{{ url_for('reject_deposit', user_id=deposit.user_id) }}" class="inline">
<button type="submit" class="bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-4 rounded transition">
‚úó REJECT
</button>
</form>
</div>
</div>
{% endfor %}
</div>
</div>
{% endif %}

<div class="grid grid-cols-2 md:grid-cols-7 gap-4 mb-8">

<div class="bg-market-gray border border-green-500 p-4 rounded-lg text-center shadow-lg">
    <h3 class="text-green-500 text-sm mb-1">WEB SESSIONS</h3>
    <div class="text-3xl text-red-500 font-bold">{{ stats.total_sessions }}</div>
</div>

<div class="bg-market-gray border border-green-500 p-4 rounded-lg text-center shadow-lg">
    <h3 class="text-green-500 text-sm mb-1">TOTAL EVENTS</h3>
    <div class="text-3xl text-red-500 font-bold">{{ stats.total_events }}</div>
</div>

<div class="bg-market-gray border border-green-500 p-4 rounded-lg text-center shadow-lg">
    <h3 class="text-green-500 text-sm mb-1">REGISTRATIONS</h3>
    <div class="text-3xl text-red-500 font-bold">{{ stats.total_registrations }}</div>
</div>

<div class="bg-market-gray border border-green-500 p-4 rounded-lg text-center shadow-lg">
    <h3 class="text-green-500 text-sm mb-1">PURCHASES</h3>
    <div class="text-3xl text-red-500 font-bold">{{ stats.total_purchases }}</div>
</div>

<div class="bg-market-gray border border-red-700 p-4 rounded-lg text-center shadow-lg animate-pulse">
    <h3 class="text-red-500 text-sm mb-1">üéØ BAIT DOWNLOADS</h3>
    <div class="text-3xl text-red-500 font-extrabold">{{ stats.total_downloads }}</div>
</div>

<div class="bg-market-gray border border-cyan-500 p-4 rounded-lg text-center shadow-lg">
    <h3 class="text-cyan-500 text-sm mb-1">üîê SSH SESSIONS</h3>
    <div class="text-3xl text-cyan-400 font-bold">{{ stats.total_ssh_sessions }}</div>
</div>

<div class="bg-market-gray border border-cyan-500 p-4 rounded-lg text-center shadow-lg">
    <h3 class="text-cyan-500 text-sm mb-1">‚å®Ô∏è SSH COMMANDS</h3>
    <div class="text-3xl text-cyan-400 font-bold">{{ stats.total_ssh_commands }}</div>
</div>

</div>

<div class="space-y-8">

<!-- PROFILING SUMMARY -->
<div class="bg-market-gray border border-purple-500 p-6 rounded-lg shadow-xl overflow-x-auto">
    <h2 class="text-purple-400 font-bold text-xl mb-4 border-b border-purple-600 pb-2">üìä ACTIVITY PROFILES</h2>
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="p-4 bg-gray-900 rounded">
            <h3 class="text-sm text-gray-300">Top IPs</h3>
            <ul class="text-xs text-gray-400 mt-2">
                {% for ip, cnt in profiles.top_ips %}
                <li class="truncate">{{ loop.index }}. <span class="text-yellow-300 font-mono">{{ ip }}</span> ‚Äî {{ cnt }}</li>
                {% else %}
                <li class="text-gray-500">No IP data</li>
                {% endfor %}
            </ul>
        </div>

        <div class="p-4 bg-gray-900 rounded">
            <h3 class="text-sm text-gray-300">Top SSH Commands</h3>
            <ul class="text-xs text-gray-400 mt-2">
                {% for cmd, cnt in profiles.top_ssh_commands %}
                <li class="truncate">{{ loop.index }}. <span class="font-mono text-cyan-300">{{ cmd }}</span> ‚Äî {{ cnt }}</li>
                {% else %}
                <li class="text-gray-500">No SSH command data</li>
                {% endfor %}
            </ul>
        </div>

        <div class="p-4 bg-gray-900 rounded">
            <h3 class="text-sm text-gray-300">Top Web Paths</h3>
            <ul class="text-xs text-gray-400 mt-2">
                {% for path, cnt in profiles.top_web_paths %}
                <li class="truncate">{{ loop.index }}. <span class="text-red-300">{{ path }}</span> ‚Äî {{ cnt }}</li>
                {% else %}
                <li class="text-gray-500">No web path data</li>
                {% endfor %}
            </ul>
        </div>

        <div class="p-4 bg-gray-900 rounded">
            <h3 class="text-sm text-gray-300">User & Session Averages</h3>
            <div class="text-xs text-gray-400 mt-2 space-y-1">
                <div>SSH Sessions: <span class="font-mono text-cyan-300">{{ profiles.total_ssh_sessions or 0 }}</span></div>
                <div>SSH Commands: <span class="font-mono text-cyan-300">{{ profiles.total_ssh_commands or 0 }}</span></div>
                <div>Avg Cmd / SSH Session: <span class="font-mono text-green-300">{{ "%.2f"|format(profiles.avg_commands_per_ssh_session or 0) }}</span></div>
                <div>Web Sessions: <span class="font-mono text-red-300">{{ profiles.total_web_sessions or 0 }}</span></div>
                <div>Avg Events / Web Session: <span class="font-mono text-green-300">{{ "%.2f"|format(profiles.avg_events_per_web_session or 0) }}</span></div>
            </div>
        </div>
    </div>
    <div class="mt-4 flex gap-2">
        <form method="POST" action="{{ url_for('admin_train_profiler') }}">
            <button type="submit" class="bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2 px-4 rounded">Train Profiler</button>
        </form>
        <form method="GET" action="{{ url_for('admin_export_labeled_ssh') }}">
            <button type="submit" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">Export Labeled SSH CSV</button>
        </form>
        <form method="POST" action="{{ url_for('admin_run_predictions') }}">
            <button type="submit" class="bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-2 px-4 rounded">Run Predictions</button>
        </form>
    </div>
</div>

<!-- SSH HONEYPOT SECTION -->
<div class="bg-market-gray border border-cyan-500 p-6 rounded-lg shadow-xl overflow-x-auto">
    <h2 class="text-cyan-400 font-bold text-xl mb-4 border-b border-cyan-600 pb-2">üîê SSH HONEYPOT SESSIONS</h2>
    {% if ssh_sessions %}
    <table class="w-full text-left text-sm text-gray-400">
        <thead class="text-xs text-cyan-400 uppercase bg-gray-800">
            <tr>
                <th scope="col" class="px-3 py-2">Session ID</th>
                <th scope="col" class="px-3 py-2">IP Address</th>
                <th scope="col" class="px-3 py-2">Username</th>
                <th scope="col" class="px-3 py-2">Start Time</th>
                <th scope="col" class="px-3 py-2">End Time</th>
                <th scope="col" class="px-3 py-2">Commands</th>
                <th scope="col" class="px-3 py-2">Profile</th>
                <th scope="col" class="px-3 py-2">Label</th>
            </tr>
        </thead>
        <tbody>
            {% for s in ssh_sessions %}
            <tr class="bg-market-gray border-b border-market-border hover:bg-gray-800">
                <td class="px-3 py-2">
                    <span class="text-cyan-400 font-mono text-xs">{{ s.session_id[:16] }}...</span>
                </td>
                <td class="px-3 py-2 text-yellow-400 font-semibold">{{ s.ip_address }}</td>
                <td class="px-3 py-2 text-green-400">{{ s.username }}</td>
                <td class="px-3 py-2 text-xs">{{ s.start_time }}</td>
                <td class="px-3 py-2 text-xs">{{ s.end_time or 'Active' }}</td>
                <td class="px-3 py-2 font-bold text-cyan-300">{{ s.command_count }}</td>
                <td class="px-3 py-2 text-xs text-purple-300 font-semibold">
                    {% set pred = ssh_predictions.get(s.session_id) %}
                    {{ pred.label if pred else 'n/a' }}
                </td>
                <td class="px-3 py-2">
                    <form method="POST" action="{{ url_for('admin_label_ssh_session', session_id=s.session_id) }}" class="flex gap-2">
                        <select name="label" class="bg-gray-800 text-xs text-gray-300 p-1 rounded">
                            <option value="data_exfiltrator">data_exfiltrator</option>
                            <option value="fraudster">fraudster</option>
                            <option value="interactive_recon">interactive_recon</option>
                            <option value="scanner">scanner</option>
                        </select>
                        <button type="submit" class="bg-blue-600 hover:bg-blue-500 text-white text-xs px-2 py-1 rounded">Label</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="text-gray-500 text-center py-4">No SSH sessions recorded yet</p>
    {% endif %}
</div>

<!-- SSH COMMANDS SECTION -->
<div class="bg-market-gray border border-cyan-500 p-6 rounded-lg shadow-xl overflow-x-auto">
    <h2 class="text-cyan-400 font-bold text-xl mb-4 border-b border-cyan-600 pb-2">‚å®Ô∏è SSH COMMANDS (Last 100)</h2>
    {% if ssh_commands %}
    <table class="w-full text-left text-sm text-gray-400">
        <thead class="text-xs text-cyan-400 uppercase bg-gray-800">
            <tr>
                <th scope="col" class="px-3 py-2">Timestamp</th>
                <th scope="col" class="px-3 py-2">Session</th>
                <th scope="col" class="px-3 py-2">Command</th>
                <th scope="col" class="px-3 py-2">Response Preview</th>
                <th scope="col" class="px-3 py-2">Status</th>
            </tr>
        </thead>
        <tbody>
            {% for cmd in ssh_commands %}
            <tr class="bg-market-gray border-b border-market-border hover:bg-gray-800">
                <td class="px-3 py-2 text-xs">{{ cmd.timestamp }}</td>
                <td class="px-3 py-2 text-xs font-mono text-cyan-500">{{ cmd.session_id[:12] }}...</td>
                <td class="px-3 py-2 font-mono text-yellow-300">{{ cmd.command }}</td>
                <td class="px-3 py-2 text-xs text-gray-500 max-w-xs truncate">{{ cmd.response[:100] }}...</td>
                <td class="px-3 py-2">
                    {% if cmd.success %}
                        <span class="text-green-500 font-bold">‚úì</span>
                    {% else %}
                        <span class="text-red-500 font-bold">‚úó</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="text-gray-500 text-center py-4">No SSH commands recorded yet</p>
    {% endif %}
</div>

<div class="bg-market-gray border border-green-500 p-6 rounded-lg shadow-xl overflow-x-auto">
    <h2 class="text-red-500 font-bold text-xl mb-4 border-b border-market-border pb-2">üîç ACTIVE WEB SESSIONS</h2>
    <table class="w-full text-left text-sm text-gray-400">
        <thead class="text-xs text-red-500 uppercase bg-gray-800">
            <tr>
                <th scope="col" class="px-3 py-2">Session ID</th>
                <th scope="col" class="px-3 py-2">IP Address</th>
                <th scope="col" class="px-3 py-2">First Seen</th>
                <th scope="col" class="px-3 py-2">Last Seen</th>
                <th scope="col" class="px-3 py-2">Events</th>
                <th scope="col" class="px-3 py-2">Pages</th>
                <th scope="col" class="px-3 py-2">Products</th>
                <th scope="col" class="px-3 py-2">Cart</th>
                <th scope="col" class="px-3 py-2">Downloads</th>
                <th scope="col" class="px-3 py-2">Purchases</th>
                <th scope="col" class="px-3 py-2">Reg.</th>
                <th scope="col" class="px-3 py-2">Profile</th>
            </tr>
        </thead>
        <tbody>
            {% for s in sessions %}
            <tr class="bg-market-gray border-b border-market-border hover:bg-gray-800">
                <td class="px-3 py-2">
                    <a href="{{ url_for('admin_session_detail', session_id=s.session_id) }}" class="text-cyan-400 hover:text-cyan-300 font-mono text-xs">
                        {{ s.session_id[:12] }}...
                    </a>
                </td>
                <td class="px-3 py-2">{{ s.ip_address }}</td>
                <td class="px-3 py-2 text-xs">{{ s.first_seen }}</td>
                <td class="px-3 py-2 text-xs">{{ s.last_seen }}</td>
                <td class="px-3 py-2 font-semibold">{{ s.total_events }}</td>
                <td class="px-3 py-2">{{ s.pages_viewed }}</td>
                <td class="px-3 py-2">{{ s.products_viewed }}</td>
                <td class="px-3 py-2">{{ s.cart_additions }}</td>
                <td class="px-3 py-2">
                    {% if s.downloads_attempted > 0 %}
                        <span class="text-red-500 font-bold">{{ s.downloads_attempted }} üéØ</span>
                    {% else %}
                        {{ s.downloads_attempted }}
                    {% endif %}
                </td>
                <td class="px-3 py-2">{{ s.purchases_made }}</td>
                <td class="px-3 py-2 text-xl font-bold">{{ '‚úì' if s.registered else '‚úó' }}</td>
                <td class="px-3 py-2">{{ s.assigned_profile or 'N/A' }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="bg-market-gray border border-green-500 p-6 rounded-lg shadow-xl overflow-x-auto">
    <h2 class="text-red-500 font-bold text-xl mb-4 border-b border-market-border pb-2">üìã RECENT EVENTS (Last 100)</h2>
    <table class="w-full text-left text-sm text-gray-400">
        <thead class="text-xs text-red-500 uppercase bg-gray-800">
            <tr>
                <th scope="col" class="px-3 py-2">Timestamp</th>
                <th scope="col" class="px-3 py-2">Event Type</th>
                <th scope="col" class="px-3 py-2">IP Address</th>
                <th scope="col" class="px-3 py-2">User</th>
                <th scope="col" class="px-3 py-2">Endpoint</th>
                <th scope="col" class="px-3 py-2">Product ID</th>
                <th scope="col" class="px-3 py-2">Additional Data</th>
            </tr>
        </thead>
        <tbody>
            {% for event in events %}
            <tr class="bg-market-gray border-b border-market-border hover:bg-gray-800">
                <td class="px-3 py-2 text-xs">{{ event.timestamp }}</td>
                <td class="px-3 py-2">
                    {% set event_color = {
                        'DOWNLOAD': 'bg-red-600 text-black',
                        'PURCHASE': 'bg-orange-500 text-black',
                        'REGISTER': 'bg-green-500 text-black',
                        'LOGIN': 'bg-cyan-400 text-black',
                        'PRODUCT_VIEW': 'bg-purple-500 text-white',
                        'CART_ADD': 'bg-yellow-400 text-black',
                        'DEPOSIT_ATTEMPT': 'bg-yellow-600 text-black',
                        'ADMIN_DEPOSIT_CONFIRMED': 'bg-green-700 text-white',
                        'ADMIN_DEPOSIT_REJECTED': 'bg-red-700 text-white'
                    }.get(event.event_type, 'bg-gray-600 text-white') %}
                    <span class="inline-block px-2 py-1 text-xs font-semibold rounded {{ event_color }}">
                        {{ event.event_type }}
                    </span>
                </td>
                <td class="px-3 py-2">{{ event.ip_address }}</td>
                <td class="px-3 py-2">{{ event.username or 'Anonymous' }}</td>
                <td class="px-3 py-2">{{ event.path }}</td>
                <td class="px-3 py-2 text-xs font-mono">{{ event.product_id or '-' }}</td>
                <td class="px-3 py-2 text-xs text-gray-500">{{ event.additional_data }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>


</div>
{% endblock %}