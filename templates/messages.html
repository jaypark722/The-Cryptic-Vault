{% extends "base.html" %}
{% block title %}THE CRYPTIC VAULT | Messages{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto py-10 px-4 sm:px-6 lg:px-8">
    <h2 class="text-3xl text-market-gold font-bold mb-6 border-b border-market-border pb-3">
        Secure Inbox
    </h2>

    {% with flashes = get_flashed_messages(with_categories=true) %}
    {% if flashes %}
        {% for category, message in flashes %}
            <div class="p-3 mb-4 text-sm {% if category == 'success' %}text-green-700 bg-green-100{% else %}text-red-700 bg-red-100{% endif %} rounded-lg dark:text-gray-900" role="alert">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}
    {% endwith %}

    {% if messages %}
        <div id="inbox-list" class="space-y-3">
            {% for message in messages %}
            {% set background_color = 'bg-market-gray-light' if message.is_read else 'bg-market-gray' %}
            {% set text_color = 'text-gray-300' if message.is_read else 'text-white' %}

            <div class="{{ background_color }} border border-market-border p-4 rounded-lg shadow-md transition duration-150 message-container" id="message-container-{{ message.id }}">
                <div class="flex justify-between items-start">
                    <div 
                        class="flex-grow min-w-0 flex cursor-pointer p-2 -m-2 rounded hover:bg-market-gray-dark transition duration-100 message-header"
                        data-message-id="{{ message.id }}"
                        data-mark-read-url="{{ url_for('mark_read', message_id=message.id) }}">
                        <div class="flex justify-between items-center w-full">
                            <div class="flex items-center space-x-4">
                                <span class="text-sm font-mono {{ text_color }} flex-shrink-0">
                                    [{{ message.timestamp.strftime('%Y-%m-%d %H:%M') }}]
                                </span>
                                <span class="font-bold text-sm text-market-gold flex-shrink-0">
                                    {{ message.sender_username }}
                                </span>
                                <span class="font-bold {{ text_color }} truncate max-w-sm">
                                    {{ message.subject }}
                                </span>
                            </div>
                            <span 
                                id="status-{{ message.id }}" 
                                class="text-sm {% if message.is_read %}text-gray-500{% else %}text-red-500 font-bold{% endif %} flex-shrink-0 ml-4">
                                {{ "READ" if message.is_read else "NEW" }}
                            </span>
                        </div>
                    </div>

                    <form 
                        action="{{ url_for('delete_message', message_id=message.id) }}" 
                        method="POST" 
                        class="ml-4 flex-shrink-0" 
                        onsubmit="return confirm('Are you sure you want to delete this message?')">
                        <button type="submit" class="text-gray-400 hover:text-red-500 transition-colors p-2 rounded">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                      d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7
                                          m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                                </path>
                            </svg>
                        </button>
                    </form>
                </div>

                <div class="message-body hidden mt-4 pt-4 border-t border-market-border">
                    <p class="whitespace-pre-wrap text-gray-400 font-mono text-sm">
                        {{ message.body }}
                    </p>
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <p class="text-gray-400 p-8 border border-market-border rounded-lg bg-market-gray text-center">
            Your inbox is empty. No communications from Admin or vendors yet.
        </p>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.message-header').forEach(header => {
        header.addEventListener('click', () => {
            const id = header.dataset.messageId;
            const container = document.getElementById('message-container-' + id);
            const body = container.querySelector('.message-body');
            const url = header.dataset.markReadUrl;
            const status = document.getElementById('status-' + id);
            
            // NOTE: The header element is the span within the MESSAGES link.
            // In the header.html, it's: 
            // (<span class="text-red-500 font-bold" id="message-count">{{ msg_count }}</span>)
            const msgCountEl = document.getElementById('message-count');

            // Toggle message visibility
            body.classList.toggle('hidden');

            // If it was NEW â†’ mark as READ + update badge
            if (status && status.textContent.trim() === 'NEW') {
                // 1. Update message status locally
                status.textContent = 'READ';
                status.classList.remove('text-red-500', 'font-bold');
                status.classList.add('text-gray-500');

                // 2. Decrease message count in header
                if (msgCountEl) {
                    let count = parseInt(msgCountEl.textContent.trim()) || 0;
                    if (count > 0) {
                        count -= 1;
                        msgCountEl.textContent = count;
                        
                        // If count drops to 0, change color from red to gray
                        if (count === 0) {
                            msgCountEl.classList.remove('text-red-500');
                            msgCountEl.classList.add('text-gray-400');
                        }
                    }
                }

                // 3. Update server and database
                fetch(url).catch(err => console.error('Failed to mark as read:', err));
            }
        });
    });
});
</script>
{% endblock %}