{% extends "base.html" %}
{% block title %}THE CRYPTIC VAULT | Profile{% endblock %}

{% block content %}
<div class="w-full bg-market-gray border border-market-gold p-8 rounded-lg shadow-xl">
    <h2 class="text-3xl text-market-gold font-bold mb-6 border-b border-market-border pb-3">Handler Profile: {{ user_data.username }}</h2>
    
    {% if error %}
        <p class="bg-red-900 border border-red-500 text-white p-3 rounded mb-4">{{ error }}</p>
    {% endif %}
    
    {% if success %}
        <p class="bg-green-900 border border-green-500 text-white p-3 rounded mb-4">{{ success }}</p>
    {% endif %}

    {% if encrypted_delivery %}
    <div class="mb-6 p-6 border border-green-500 rounded-lg bg-market-black">
        <h3 class="text-xl text-green-500 font-bold mb-3 flex items-center">
            <i class="fas fa-lock mr-3"></i> SECURE DELIVERY: Order Fulfilled
        </h3>
        <p class="text-gray-400 text-sm mb-4">Your purchased file has been successfully encrypted using your public key. Copy the message below and use your private key to decrypt the file locally.</p>
        
        <label for="encrypted_message" class="block text-white text-sm font-bold mb-2">Encrypted PGP Message (Cryptic Data Leak File):</label>
        <textarea id="encrypted_message" rows="12" readonly
                        class="w-full bg-gray-900 border border-green-700 text-green-300 p-3 text-xs font-mono resize-none focus:outline-none">{{ encrypted_delivery }}</textarea>
    </div>
    {% endif %}
    <div class="space-y-4">
        <div class="flex justify-between border-b border-gray-700 pb-2">
            <span class="text-gray-400 font-semibold">Current Balance:</span>
            <span class="text-market-gold font-bold text-xl">{{ user_data.balance }}</span>
        </div>
        
        <div class="flex justify-between border-b border-gray-700 pb-2">
            <span class="text-gray-400 font-semibold">PGP Status:</span>
            <span class="{{ user_data.pgp_color }} font-bold">{{ user_data.pgp_status }} 
                {% if user_data.pgp_status == 'UNVERIFIED' %}(Verify for higher limits){% endif %}
            </span>
        </div>

        <div class="border border-market-border p-4 rounded-lg bg-market-black">
            <h3 class="text-lg font-bold mb-2 
                {% if user_data.pgp_status == 'VERIFIED' %}text-green-500{% else %}text-red-400{% endif %}">
                PGP Public Key ({{ user_data.pgp_status }})
            </h3>
            
            {% if session.get('pgp_verified') %}
                <textarea rows="5" readonly class="w-full bg-market-black border border-market-border text-gray-300 p-2 text-xs font-mono resize-none">{{ user_data.pgp_key }}</textarea>
            {% else %}
                <p class="text-sm text-red-400 mb-4">You must submit your PGP Public Key to verify your account and enable secure purchases.</p>
                
                <form action="{{ url_for('profile') }}" method="POST">
                    <label for="pgp_key_submission" class="block text-gray-400 mb-2">Paste your PGP Public Key (ASCII Armored Block):</label>
                    <textarea id="pgp_key_submission" name="pgp_key_submission" rows="8" class="w-full bg-market-border text-white p-3 rounded font-mono text-sm" placeholder="-----BEGIN PGP PUBLIC KEY BLOCK-----..."></textarea>
                    <button type="submit" class="mt-4 w-full bg-green-700 hover:bg-green-600 text-white font-bold py-2 rounded transition duration-150">
                        VERIFY & ADD PGP KEY
                    </button>
                </form>
            {% endif %}
        </div>
        
        <div class="flex justify-between border-b border-gray-700 pb-2">
            <span class="text-gray-400 font-semibold">Member Since:</span>
            <span class="text-white">TODAY</span>
        </div>
    </div>
    
    <div class="mt-8">
        <h3 class="text-xl text-white font-bold border-b border-market-border pb-2 mb-4">Account Actions</h3>
        <div class="flex space-x-4">
            <a href="{{ url_for('wallet') }}" class="bg-blue-800 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition duration-150">Manage Wallet</a>
            <a href="{{ url_for('orders') }}" class="bg-market-gold hover:bg-yellow-400 text-black font-bold py-2 px-4 rounded transition duration-150">View Orders</a>
            <button onclick="document.getElementById('password-form').classList.toggle('hidden')" class="bg-yellow-700 hover:bg-yellow-600 text-black font-bold py-2 px-4 rounded transition duration-150">
                Change Password
            </button>
        </div>
    </div>

    <div id="password-form" class="hidden mt-8 p-6 bg-market-black border border-market-border rounded-lg max-w-lg">
        <h4 class="text-lg text-red-400 font-bold mb-4">PASSWORD RESET **HIGH SECURITY**</h4>
        <form method="POST" action="{{ url_for('change_password') }}">
            
            <div class="mb-4 relative">
                <label for="current_password" class="block text-gray-400 text-sm font-bold mb-2">Current Password</label>
                <input type="password" id="current_password" name="current_password" required 
                        class="shadow appearance-none border border-market-border bg-white rounded w-full py-2 px-3 text-black leading-tight focus:outline-none focus:shadow-outline">
                <i class="fas fa-eye-slash absolute right-3 top-1/2 toggle-icon cursor-pointer text-gray-600" 
                    id="toggle-current_password" onclick="togglePassword('current_password')"></i>
            </div>
            
            <div class="mb-4 relative">
                <label for="new_password" class="block text-gray-400 text-sm font-bold mb-2">New Password (Min 8 chars)</label>
                <input type="password" id="new_password" name="new_password" required 
                        class="shadow appearance-none border border-market-border bg-white rounded w-full py-2 px-3 text-black leading-tight focus:outline-none focus:shadow-outline">
                <i class="fas fa-eye-slash absolute right-3 top-1/2 toggle-icon cursor-pointer text-gray-600" 
                    id="toggle-new_password" onclick="togglePassword('new_password')"></i>
            </div>

            <div class="mb-6 relative">
                <label for="confirm_password" class="block text-gray-400 text-sm font-bold mb-2">Confirm New Password</label>
                <input type="password" id="confirm_password" name="confirm_password" required 
                        class="shadow appearance-none border border-market-border bg-white rounded w-full py-2 px-3 text-black leading-tight focus:outline-none focus:shadow-outline">
                <i class="fas fa-eye-slash absolute right-3 top-1/2 toggle-icon cursor-pointer text-gray-600" 
                    id="toggle-confirm_password" onclick="togglePassword('confirm_password')"></i>
            </div>

            <button type="submit" 
                        class="w-full bg-red-700 hover:bg-red-600 text-white font-bold py-2 px-4 rounded transition duration-150">
                Update Password and Log Out
            </button>
        </form>
    </div>
</div>
{% endblock %}