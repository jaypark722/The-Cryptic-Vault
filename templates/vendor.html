{% extends "base.html" %}
{% block title %}THE CRYPTIC VAULT | Become a Vendor{% endblock %}

{% block content %}
<h1 class="text-3xl font-bold text-market-gold mb-6 border-b border-market-border pb-3">VENDOR APPLICATION</h1>

<div class="bg-market-gray p-6 rounded-lg border border-red-700">
    <p class="text-red-400 mb-4 font-semibold">
        Application to sell on The Cryptic Vault requires a security deposit and Admin approval. Do not submit sensitive data here.
    </p>

    {% if success %}
    <div class="bg-green-900 bg-opacity-30 border border-green-700 p-3 rounded-md mb-4">
        <p class="text-green-300 font-semibold">{{ success }}</p>
    </div>
    <script>
    // After a successful vendor submission, poll the server after 5 seconds
    // to update the messages badge in the header so the user sees the new message.
    // Try fetching message count up to 4 times, starting after 5s, with 2s intervals
    (function pollMessageCount(attemptsLeft, delayMs){
        if(attemptsLeft <= 0) return;
        setTimeout(function(){
            fetch("{{ url_for('_message_count') }}", { credentials: 'same-origin' })
                .then(function(res){ return res.json(); })
                .then(function(data){
                    var cnt = data.count || 0;
                    if(cnt > 0){
                        var el = document.getElementById('message-count');
                        if(el){
                            el.textContent = cnt;
                        } else {
                            var msgLink = document.querySelector("a[href='{{ url_for('messages') }}']");
                            if(msgLink){
                                msgLink.innerHTML = 'MESSAGES (<span class="text-red-500 font-bold" id="message-count">'+cnt+'</span>)';
                            }
                        }
                    } else {
                        // try again
                        pollMessageCount(attemptsLeft-1, 2000);
                    }
                }).catch(function(err){
                    console.error('Failed to fetch message count', err);
                    // try again
                    pollMessageCount(attemptsLeft-1, 2000);
                });
        }, delayMs);
    })(4, 5000);
    </script>
    {% endif %}

    {% if error %}
    <div class="bg-red-900 bg-opacity-30 border border-red-700 p-3 rounded-md mb-4">
        <p class="text-red-300 font-semibold">ERROR: {{ error }}</p>
    </div>
    {% endif %}

    <form method="POST" action="{{ url_for('vendor') }}" class="space-y-4" id="vendorForm">
        <div>
            <label for="specialty" class="block text-sm font-medium text-gray-300 mb-1">Intended Product Specialty</label>
            <input type="text" id="specialty" name="specialty" required 
                    class="w-full px-4 py-2 bg-market-border border border-gray-600 rounded-md text-white focus:ring-market-gold focus:border-market-gold"
                    placeholder="e.g., Zero-Day Exploits, Fullz/CC Data, Custom Forgery">
        </div>

        <div>
            <label for="reason" class="block text-sm font-medium text-gray-300 mb-1">Reason for joining / Experience</label>
            <textarea id="reason" name="reason" rows="8" required 
                      class="w-full px-4 py-2 bg-market-border border border-gray-600 rounded-md text-white focus:ring-market-gold focus:border-market-gold"
                      placeholder="Briefly describe your experience and why you should be approved."></textarea>
        </div>

        <button type="submit" id="submitBtn" class="w-full bg-red-700 text-white font-bold py-2 hover:bg-red-600 transition duration-150 rounded-sm">
            SUBMIT VENDOR APPLICATION
        </button>
    </form>
</div>

<script>
// Prevent multiple submissions
document.getElementById('vendorForm').addEventListener('submit', function(e) {
    var submitBtn = document.getElementById('submitBtn');
    if (submitBtn.disabled) {
        e.preventDefault();
        return false;
    }
    submitBtn.disabled = true;
    submitBtn.textContent = 'SUBMITTING...';
    submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
});
</script>

{% endblock %}